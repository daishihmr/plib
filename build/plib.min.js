/*
 * plib.js v0.0.0
 * http://tomcat.dev7.jp/gitbucket/daishi/plib
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */


var SC_W=SC_W||320,SC_H=SC_H||320,SC_ASPECT=SC_W/SC_H,SC_ASPECT_INV=SC_H/SC_W,IS_MOBILE=-1!==window.navigator.userAgent.indexOf("iPhone")||-1!==window.navigator.userAgent.indexOf("Android");HTMLCanvasElement.prototype.getContext2d=function(a){a=!!a;var b=this.getContext("2d");return b.hasOwnProperty("imageSmoothingEnabled")?b.imageSmoothingEnabled=a:b.hasOwnProperty("mozImageSmoothingEnabled")?b.mozImageSmoothingEnabled=a:b.hasOwnProperty("webkitImageSmoothingEnabled")&&(b.webkitImageSmoothingEnabled=a),b};var Event=function(a,b){this.type=a,this.params=b},EventDispatcher=function(){this.listeners={}};EventDispatcher.prototype.on=function(a,b){return void 0===this.listeners[a]&&(this.listeners[a]=[]),this.listeners[a].push(b),this},EventDispatcher.prototype.one=function(a,b){var c=function(d){b.call(this,d),this.off(a,c)};this.on(a,c)},EventDispatcher.prototype.off=function(a,b){void 0===this.listeners[a]&&(this.listeners[a]=[]);var c=this.listeners[a],d=c.indexOf(b);return d>=0&&c.splice(d,1),this["on"+a]&&delete this["on"+a],this},EventDispatcher.prototype.clearEventListener=function(a){this.listeners[a]=[],this["on"+a]&&delete this["on"+a]},EventDispatcher.prototype.fire=function(a){this["on"+a.type]&&this["on"+a.type](a);var b=this.listeners[a.type];if(void 0!==b)for(var c=[].concat(b),d=0,e=c.length;e>d;d++)c[d].call(this,a);return this},EventDispatcher.prototype.flare=function(a){return this.fire(new Event(a))};var Application=function(a,b){window.document.body.style.background="black",Application.INSTANCE=this,this.stats=null,"r.jsgames.jp"!==window.location.host&&window.Stats&&(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",window.document.body.appendChild(this.stats.domElement));var c=window.document.createElement("div");window.document.body.appendChild(c),c.style.position="absolute",c.style.top=c.style.left=0,c.style.cursor="default",this.layerCount=a||1,this.mainLayerIndex=b||0,this.layers=[];for(var d=0;d<this.layerCount;d++)this.addNewLayer();this._canvasLeft=0,this._canvasTop=0,this._canvasScale=0;var e=function(){if(c.style.width=window.innerWidth+"px",c.style.height=window.innerHeight+"px",window.innerWidth/window.innerHeight<SC_ASPECT){this._canvasLeft=0,this._canvasTop=.5*(window.innerHeight-window.innerWidth*SC_ASPECT_INV),this._canvasScale=SC_W/window.innerWidth;for(var a=0;a<this.layerCount;a++){var b=this.layers[a].style;b.width=window.innerWidth+"px",b.height=window.innerWidth*SC_ASPECT_INV+"px",b.left=this._canvasLeft+"px",b.top=this._canvasTop+"px"}}else{this._canvasLeft=.5*(window.innerWidth-window.innerHeight*SC_ASPECT),this._canvasTop=0,this._canvasScale=SC_H/window.innerHeight;for(var a=0;a<this.layerCount;a++){var b=this.layers[a].style;b.width=window.innerHeight*SC_ASPECT+"px",b.height=window.innerHeight+"px",b.left=this._canvasLeft+"px",b.top=this._canvasTop+"px"}}}.bind(this);e(),window.addEventListener("resize",e,!1),this.context=this.layers[this.mainLayerIndex].getContext2d(),this.pointing={isStart:!1,isPointing:!1,isEnd:!1,x:0,y:0,beforeX:0,beforeY:0,deltaX:0,deltaY:0};var f={10:{x:Math.cos(0*Math.PI),y:Math.sin(0*Math.PI)},1010:{x:Math.cos(.25*Math.PI),y:Math.sin(.25*Math.PI)},1e3:{x:Math.cos(.5*Math.PI),y:Math.sin(.5*Math.PI)},1001:{x:Math.cos(.75*Math.PI),y:Math.sin(.75*Math.PI)},1:{x:Math.cos(1*Math.PI),y:Math.sin(1*Math.PI)},101:{x:Math.cos(1.25*Math.PI),y:Math.sin(1.25*Math.PI)},100:{x:Math.cos(1.5*Math.PI),y:Math.sin(1.5*Math.PI)},110:{x:Math.cos(1.75*Math.PI),y:Math.sin(1.75*Math.PI)}},g={10:0*Math.PI,1010:.25*Math.PI,1e3:.5*Math.PI,1001:.75*Math.PI,1:1*Math.PI,101:1.25*Math.PI,100:1.5*Math.PI,110:1.75*Math.PI};this.keyboard={up:!1,down:!1,left:!1,right:!1,c:!1,z:!1,x:!1,vector:function(){return f[1e3*this.down+100*this.up+10*this.right+1*this.left]||{x:0,y:0}},angle:function(){return g[1e3*this.down+100*this.up+10*this.right+1*this.left]||null}},this._beforeTouching=!1,this._touching=!1,window.document.body.addEventListener("touchstart",function(a){var b=a.touches[0];this._touching=!0,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchmove",function(a){var b=a.touches[0];this._touching=!0,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchend",function(a){var b=a.touches[0];this._touching=!1,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mousedown",function(a){this._touching=!0,this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mousemove",function(a){this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mouseup",function(a){this._touching=!1,this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("keydown",function(a){var b=!1;switch(a.keyCode){case 38:this.keyboard.up=!0,b=!0;break;case 37:this.keyboard.left=!0,b=!0;break;case 39:this.keyboard.right=!0,b=!0;break;case 40:this.keyboard.down=!0,b=!0;break;case 67:this.keyboard.c=!0;break;case 88:this.keyboard.x=!0;break;case 90:this.keyboard.z=!0}b&&(a.stopPropagation(),a.preventDefault())}.bind(this),!1),window.addEventListener("keyup",function(a){var b=!1;switch(a.keyCode){case 38:this.keyboard.up=!1,b=!0;break;case 37:this.keyboard.left=!1,b=!0;break;case 39:this.keyboard.right=!1,b=!0;break;case 40:this.keyboard.down=!1,b=!0;break;case 67:this.keyboard.c=!1;break;case 88:this.keyboard.x=!1;break;case 90:this.keyboard.z=!1}b&&(a.stopPropagation(),a.preventDefault())}.bind(this),!1),this.frame=0,this.slowRate=1,this.slowRateAdded=0,this.currentScene=new Scene,this.sceneStack=[this.currentScene];var h=function(){null!==this.stats&&this.stats.update(),this.update(),this.draw(),window.requestAnimationFrame(h)}.bind(this);h()};Application.prototype.end=function(){},Application.prototype.update=function(){if(this.slowRateAdded+=this.slowRate,this.slowRateAdded>=1){this.slowRateAdded-=1;var a=this.pointing;if(!this._beforeTouching&&this._touching?(a.isStart=!0,a.isPointing=!1,a.isEnd=!1,a.deltaX=0,a.deltaY=0):this._beforeTouching&&this._touching?(a.isStart=!1,a.isPointing=!0,a.isEnd=!1,a.deltaX=~~(10*(a.x-a.beforeX))/10,a.deltaY=~~(10*(a.y-a.beforeY))/10):this._beforeTouching&&!this._touching?(a.isStart=!1,a.isPointing=!1,a.isEnd=!0,a.deltaX=~~(10*(a.x-a.beforeX))/10,a.deltaY=~~(10*(a.y-a.beforeY))/10):(a.isStart=!1,a.isPointing=!1,a.isEnd=!1,a.deltaX=~~(10*(a.x-a.beforeX))/10,a.deltaY=~~(10*(a.y-a.beforeY))/10),this._beforeTouching=this._touching,this.currentScene){var b=new Event("enterframe",{frame:this.frame,app:this});Object.freeze(b),this.currentScene._update(this,b)}a.beforeX=a.x,a.beforeY=a.y}this.frame+=1},Application.prototype.addNewLayer=function(){var a=window.document.createElement("canvas");window.document.body.appendChild(a),a.style.position="absolute",a.width=SC_W,a.height=SC_H,a.style.cursor="default",this.layers.push(a)},Application.prototype.draw=function(){this.context.clearRect(0,0,SC_W,SC_H);for(var a=0,b=this.sceneStack.length;b>a;a++)this.sceneStack[a]._draw(this.context)},Application.prototype.replaceScene=function(a){this.currentScene&&(this.currentScene.app=null,this.currentScene.flare("exit")),this.sceneStack.pop(),this.sceneStack.push(a),this.currentScene=a,this.currentScene.app=this,this.currentScene.flare("enter")},Application.prototype.pushScene=function(a){this.sceneStack.length>0&&this.sceneStack[this.sceneStack.length-1].flare("exit"),this.sceneStack.push(a),a.app=this,this.currentScene=a,a.flare("enter")},Application.prototype.popScene=function(){var a=this.sceneStack.pop();a&&(a.flare("exit"),a.app=null,this.sceneStack.length>0?(this.currentScene=this.sceneStack[this.sceneStack.length-1],this.currentScene.flare("enter")):this.currentScene=null)},Application.INSTANCE=null;var Node=function(){EventDispatcher.call(this),this.parent=null,this.children=[],this.frame=0,this.visible=!0};Node.prototype=Object.create(EventDispatcher.prototype),Node.prototype.addChild=function(a){a.parent=this,this.children.push(a),a.flare("added")},Node.prototype.addChildTo=function(a){return a.addChild(this),this},Node.prototype.removeChild=function(a){var b=this.children.indexOf(a);b>=0&&(a.parent=null,this.children.splice(b,1),a.flare("removed"))},Node.prototype.remove=function(){return null!==this.parent&&this.parent.removeChild(this),this},Node.prototype._update=function(a,b){if(this.update(a)!==!0){for(var c=[].concat(this.children),d=0,e=c.length;e>d;d++)c[d]._update(a,b);this.fire(b),this.frame+=1}},Node.prototype._draw=function(a){if(a.save(),this.visible){this.predraw(a),this.draw(a);for(var b=0,c=this.children.length;c>b;b++)this.children[b]._draw(a)}a.restore()},Node.prototype.update=function(){},Node.prototype.predraw=function(){},Node.prototype.draw=function(){},Node.prototype.onadded=function(){},Node.prototype.onremoved=function(){};var Object2d=function(){Node.call(this),this.width=0,this.height=0,this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.originX=.5,this.originY=.5};Object2d.prototype=Object.create(Node.prototype),Object2d.prototype.predraw=function(a){a.translate(this.x,this.y),a.rotate(this.rotation),a.scale(this.scaleX,this.scaleY)},Object2d.prototype.setPosition=function(a,b){return this.x=a,this.y=b,this},Object2d.prototype.setOrigin=function(a,b){return this.originX=a,this.originY=b,this},Object2d.prototype.setScale=function(a,b){return 1===arguments.length&&(b=a),this.scaleX=a,this.scaleY=b,this},Object2d.prototype.setRotation=function(a){return this.rotation=a,this};var Menu=function(){Node.call(this),this.selected=null,this.enabled=!0};Menu.prototype=Object.create(Node.prototype),Menu.prototype.update=function(a){if(this.enabled)for(var b=a.pointing,c=0,d=this.children.length;d>c;c++){var e=this.children[c];if(e.scaleX=e.scaleY=this.selected===e?1+.1*Math.sin(.3*a.frame):1,b.isEnd&&e.isHitPoint(b)){this.selected===e?this.onSelectItem(e):(this.selected=e,this.onPreSelectItem(e));break}}},Menu.prototype.enable=function(){this.enabled=!0},Menu.prototype.disable=function(){this.enabled=!1;for(var a=0,b=this.children.length;b>a;a++){var c=this.children[a];c.scaleX=c.scaleY=1}},Menu.prototype.onPreSelectItem=function(){},Menu.prototype.onSelectItem=function(){};var Layer=function(a,b){Node.call(this),this.canvas=a,a.width=SC_W,a.height=SC_H,this.context=a.getContext2d(),this.drawRate=b};Layer.prototype=Object.create(Node.prototype),Layer.prototype._draw=function(){if(this.frame%this.drawRate===0){this.context.clearRect(0,0,SC_W,SC_H),this.context.save(),this.draw(this.context);for(var a=0,b=this.children.length;b>a;a++)this.children[a]._draw(this.context);this.context.restore()}};var Scene=function(){Node.call(this),this.app=null};Scene.prototype=Object.create(Node.prototype),Scene.prototype.onenter=function(){},Scene.prototype.onexit=function(){};var Assets={},AssetLoadScene=function(a,b){Scene.call(this),this.nextScene=b,this.allCount=0;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];if("string"==typeof d){var e=d.match(/\.\w+/);if(e)switch(e[0]){case".mp3":this._loadAudio(c,d);break;case".ttf":this._loadFont(c,d);break;case".ttf":this._loadFont(c,d)}}else switch(d.type){case"sound":this._loadJsAudio(c,d.name)}this.allCount+=1}this.loadedCount=0,(new Loading).addChildTo(this)};AssetLoadScene.prototype=Object.create(Scene.prototype),AssetLoadScene.prototype._loadAudio=function(a,b){var c=new Xhr({url:b,responseType:"arraybuffer"});c.onsuccess=function(b){var c=new Sound(b),d=this;c.onload=function(){Assets[a]=this,d.loadedCount+=1}}.bind(this),c.send()},AssetLoadScene.prototype._loadJsAudio=function(a,b){for(var c=window.atob(BINARY_ASSETS[b]),d=c.length,e=new Uint8Array(d),f=0;d>f;f++){var g=c.charCodeAt(f);e[f]=g}var h=new Sound(e.buffer),i=this;h.onload=function(){Assets[a]=this,i.loadedCount+=1}},AssetLoadScene.prototype._loadFont=function(a,b){var c=window.document.createElement("style");c.textContent="@font-face {\n    font-family: '"+a+"';\n    src: url("+b+");\n}\n",window.document.head.appendChild(c);var d=window.document.createElement("span");d.style.fontFamily="'"+a+"', 'monospace'",d.innerHTML="QW@HhsXJ",window.document.body.appendChild(d);var e=d.offsetWidth;console.debug("_loadFont("+b+") before:"+e);var f=3e3,g=this,h=function(){f-=1,d.offsetWidth!==e||0>f?(console.debug("_loadFont("+b+") after:"+d.offsetWidth),window.document.body.removeChild(d),g.loadedCount+=1):window.setTimeout(h,100)};h()},AssetLoadScene.prototype.update=function(a){this.loadedCount===this.allCount&&a.replaceScene("function"==typeof this.nextScene?new this.nextScene:this.nextScene)};var Xhr=function(a){this.param=a;var b=this,c=this.xhr=new XMLHttpRequest;c.onreadystatechange=function(){4===this.readyState&&(200===this.status||201===this.status?b.onsuccess(this.response):b.onerror(this),b.oncomplete(this))};var d=a.async;if(void 0===d&&(d=!0),c.open(a.type||"GET",a.url,d),a.withCredentials&&(c.withCredentials=a.withCredentials),a.requestHeader)for(var e in a.requestHeader)a.requestHeader.hasOwnProperty(e)&&c.setRequestHeader(e,a.requestHeader[e]);a.responseType&&(c.responseType=a.responseType)};Xhr.prototype.send=function(){console.debug("xhr send to "+this.param.url),this.param.data?this.xhr.send(this.param.data):this.xhr.send()},Xhr.prototype.onsuccess=function(){},Xhr.prototype.onerror=function(){},Xhr.prototype.oncomplete=function(){};var Jsonp=function(a){this.param=a,this.callbackName="_jsonpcallback_"+(new Date).getTime()+parseInt(1e3*Math.random());var b=this;window[this.callbackName]=function(a){delete window[b.callbackName],window.document.body.removeChild(b.script),b.onsuccess(a)}};Jsonp.prototype.send=function(){console.debug("jsonp send"),this.script=window.document.createElement("script"),this.script.src=this.param.data?this.param.url+"?"+this.param.data+"&callback="+this.callbackName:this.param.url+"?callback="+this.callbackName;try{window.document.body.appendChild(this.script)}catch(a){this.onerror(a)}},Jsonp.prototype.onsuccess=function(){},Jsonp.prototype.onerror=function(){},Jsonp.prototype.oncomplete=function(){};var Sound=function(a){if(this.buffer=null,this.source=null,this.gainNode=null,null===Sound.CONTEXT)throw new Error("webkitAudioContext is not defined.");if(a instanceof ArrayBuffer)Sound.CONTEXT.decodeAudioData(a,function(a){this.buffer=a,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload()}.bind(this));else{if(!(a instanceof AudioBuffer))throw new Error("invalid data.");this.buffer=a,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload()}};Sound.prototype=Object.create(Object.prototype,{volume:{get:function(){return this.gainNode.gain.value},set:function(a){this.gainNode.gain.value=a}},loop:{get:function(){return this.source.loop},set:function(a){this.source.loop=a}},loopStart:{get:function(){return this.source.loopStart},set:function(a){this.source.loopStart=a}},loopEnd:{get:function(){return this.source.loopEnd},set:function(a){this.source.loopEnd=a}}}),Sound.prototype.onload=function(){},Sound.prototype.start=function(){this.source.start(0)},Sound.prototype.play=Sound.prototype.start,Sound.prototype.stop=function(){this.source.stop(0),this.source.disconnect();var a=this.gainNode.gain.value;this.source=Sound.CONTEXT.createBufferSource(),this.gainNode.gain.value=a,this.source.buffer=this.buffer,this.source.connect(Sound.CONTEXT.destination)},Sound.prototype.clone=function(){var a=new Sound(this.buffer);return a.volume=this.volume,a.loop=this.loop,a.loopStart=this.loopStart,a.loopEnd=this.loopEnd,a},Sound.CONTEXT=null,window.webkitAudioContext?Sound.CONTEXT=new webkitAudioContext:window.mozAudioContext?Sound.CONTEXT=new mozAudioContext:window.AudioContext&&(Sound.CONTEXT=new AudioContext);var SoundEngine={};SoundEngine.bgm=null,SoundEngine.bgmName=null,SoundEngine.playing={},SoundEngine.playSE=function(a){if(Assets[a]){if(SoundEngine.playing[a]===Application.INSTANCE.frame)return;SoundEngine.playing[a]=Application.INSTANCE.frame;var b=Assets[a].clone();b.volume=SoundEngine.seVolume,b.start()}},SoundEngine.startBgm=function(a){SoundEngine.bgmName!==a&&(SoundEngine.stopBgm(),Assets[a]&&(SoundEngine.bgmName=a,SoundEngine.bgm=Assets[a].clone(),SoundEngine.bgm.loop=!0,SoundEngine.bgm.volume=SoundEngine.bgmVolume,SoundEngine.bgm.start()))},SoundEngine.stopBgm=function(){SoundEngine.bgm&&(SoundEngine.bgm.stop(),SoundEngine.bgm=null,SoundEngine.bgmName=null)};var Sprite=function(a){Object2d.call(this),this.texture=a,this.width=a.width,this.height=a.height,this.alpha=1,this.blendMode="lighter"};Sprite.prototype=Object.create(Object2d.prototype),Sprite.prototype.draw=function(a){a.globalAlpha=this.alpha,a.globalCompositeOperation=this.blendMode,a.drawImage(this.texture,-this.width*this.originX,-this.height*this.originY)},Sprite.prototype.isHitPoint=function(a){var b=this.width*this.scaleX*.5,c=this.height*this.scaleY*.5;return this.x-b<=a.x&&a.x<this.x+b&&this.y-c<=a.y&&a.y<this.y+c},Sprite.prototype.setAlpha=function(a){return this.alpha=a,this};var Rect=function(a,b,c){var d=new Canvas(b,c).set({color:a}).drawRect(2,2,b-4,c-4).toTexture();Sprite.call(this,d)};Rect.prototype=Object.create(Sprite.prototype);var RoundRect=function(a,b,c){var d=new Canvas(b,c).set({color:a}).drawRoundRect(2,2,b-4,c-4).toTexture();Sprite.call(this,d)};RoundRect.prototype=Object.create(Sprite.prototype);var Circle=function(a,b){this.radius=b;var c=new Canvas(2*b,2*b).set({color:a}).drawCircle(b,b,b-2).toTexture();Sprite.call(this,c)};Circle.prototype=Object.create(Sprite.prototype);var Polygon=function(a,b,c){var d=window.document.createElement("canvas");d.width=2*b,d.height=2*b;var e=d.getContext2d();Util.setStyle(e,a),e.beginPath(),e.moveTo(b+Math.cos(0)*(b-2),b+Math.sin(0)*(b-2));for(var f=1;c>f;f++){var g=2*Math.PI*f/c;e.lineTo(b+Math.cos(g)*(b-2),b+Math.sin(g)*(b-2))}e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d)};Polygon.prototype=Object.create(Sprite.prototype);var RandomPolygon=function(a,b,c){var d=window.document.createElement("canvas");d.width=2*b,d.height=2*b;var e=d.getContext2d();Util.setStyle(e,a);var f=(b-2)*(.5+.5*Math.random());e.beginPath(),e.moveTo(b+Math.cos(0)*f,b+Math.sin(0)*f);for(var g=1;c>g;g++){var h=2*Math.PI*g/c;f=(b-2)*(.5+.5*Math.random()),e.lineTo(b+Math.cos(h)*f,b+Math.sin(h)*f)}e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d)};RandomPolygon.prototype=Object.create(Sprite.prototype);var Fighter=function(a,b,c){var d=new Canvas(b,c),e=d.context;Util.setStyle(e,220),e.beginPath(),e.moveTo(.35*b,.4*c),e.lineTo(.4*b,.8*c),e.lineTo(.2*b,.9*c),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(.65*b,.4*c),e.lineTo(.8*b,.9*c),e.lineTo(.6*b,.8*c),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(.5*b,.1*c),e.lineTo(.65*b,.7*c),e.lineTo(.35*b,.7*c),e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d.toTexture())};Fighter.prototype=Object.create(Sprite.prototype);var Label=function(a,b,c){this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this._text=a,this._fontSize=b||24,this._fontFamily=Label.DEFAULT_FONT,this.setColor(c||0);var d=this.updateText();Sprite.call(this,d)};Label.prototype=Object.create(Sprite.prototype,{text:{get:function(){return this._text},set:function(a){this.setText(a)}},fontSize:{get:function(){return this._fontSize},set:function(a){this.setFontSize(a)}},fontFamily:{get:function(){return this._fontFamily},set:function(a){this.setFontFamily(a)}}}),Label.prototype.setColor=function(a){this.fillStyle="hsla("+a+", 50%, 80%, 1.0)"},Label.prototype.setText=function(a){this._text=a,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.setFontSize=function(a){this._fontSize=a,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.setFontFamily=function(){this._fontFamily=fontFamily,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.updateText=function(){var a=window.document.createElement("canvas"),b=a.getContext2d(!0);b.font=""+this._fontSize+"px '"+this._fontFamily+"'";var c=b.measureText(this._text);return a.width=c.width+5,a.height=this._fontSize,b.font=""+this._fontSize+"px '"+this._fontFamily+"'",b.textAlign="center",b.textBaseline="middle",b.fillStyle=this.fillStyle,b.lineWidth=2,b.fillText(this._text,.5*a.width,.5*a.height),a},Label.DEFAULT_FONT="sans-serif";var Map=function(a){Object2d.call(this),this.width=SC_W,this.height=SC_H,this.cellsize=16,this.data=a;var b={},c=this.cellsize,d=new Canvas(Math.max(a[0].length*c,this.width),Math.max(a.length*c,this.height)),e=d.context;e.globalAlpha=.7;for(var f=0;f<a.length;f++)for(var g=0;g<a[f].length;g++){var h=a[f][g];h>=0&&(void 0===b[h]&&(b[h]=new Rect(39*h,c,c).texture),e.drawImage(b[h],c*g,c*f,c,c))}this.texture=d.toTexture()};Map.prototype=Object.create(Object2d.prototype),Map.prototype.predraw=function(){},Map.prototype.draw=function(a){a.drawImage(this.texture,-this.x,-this.y,this.width,this.height,0,0,this.width,this.height)},Map.prototype.isHitPoint=function(a){var b=parseInt((a.x-this.x)/this.cellsize),c=parseInt((a.y-this.y)/this.cellsize);return 0>c||this.data.length<=c?!1:this.data[c][b]>=0},Map.join2DArray=function(a,b,c){if(c)for(var d=0;d<a.length;d++)a[d]=a[d].concat(b[d]);else a=a.concat(b)};var GlowEffect=function(a,b,c,d){b=b||20,c=c||1.2,d=d||1;var e=new Canvas(a.width*c*2,a.height*c*2);e.drawImage(a.texture,a.width*c*.5,a.height*c*.5,a.width*c,a.height*c),e.stackBlur(b),Sprite.call(this,e.toTexture()),this.alpha=d};GlowEffect.prototype=Object.create(Sprite.prototype),Sprite.prototype.glow=function(a,b,c){return this.glowEffect=new GlowEffect(this,a,b,c).addChildTo(this),this};var Util={style:function(a){return{fillStyle:"hsla("+a+", 80%, 20%, 0.5)",strokeStyle:"hsla("+a+", 50%, 80%, 1.0)",lineWidth:2}},setStyle:function(a,b){var c=this.style(b);a.fillStyle=c.fillStyle,a.strokeStyle=c.strokeStyle,a.lineWidth=c.lineWidth},linearGradient:function(a,b,c,d,e){for(var f=window.document.createElement("canvas").getContext2d(),g=f.createLinearGradient(a,b,c,d),h=0;h<e.length;h++)g.addColorStop(e[h].offset,e[h].color);return g},radialGradient:function(a,b,c,d,e,f,g){for(var h=window.document.createElement("canvas").getContext2d(),i=h.createRadialGradient(a,b,c,d,e,f),j=0;j<g.length;j++)i.addColorStop(g[j].offset,g[j].color);return i},range:function(a,b){for(var c=[],d=a;b>d;d++)c.push(d);return c},curry:function(a){return function b(c){return c.length<a.length?function(a){return b(c.concat([a]))}:a.apply(void 0,c)}([])},rand:function(a,b){return a+Math.random()*(b-a)},randi:function(a,b){return parseInt(a+Math.random()*(b-a))},clamp:function(a,b,c){return Math.max(b,Math.min(a,c))}},Http={queryParameter:function(a){var b="",c=!0;for(var d in a)a.hasOwnProperty(d)&&(c||(b+="&"),b+=encodeURI(d)+"="+encodeURI(a[d]),c=!1);return b}},Tweener=function(a){Node.call(this),this.target=a,this.actions=[],this.actionPointer=0,this.loop=!1,this.addChildTo(a)};Tweener.prototype=Object.create(Node.prototype),Tweener.prototype.update=function(){var a=this.actions[this.actionPointer];void 0!==a&&(a.currentPos<0&&a.initialize(this.target),a.update(this.target)&&(this.actionPointer+=1,this.actions.length===this.actionPointer&&(this.loop?this.actionPointer=0:this.remove())))},Tweener.prototype.add=function(a){return this.actions.push(a),this},Tweener.prototype.to=function(a,b,c){return this.add(new TweenAction(a,b,c))},Tweener.prototype.moveTo=function(a,b,c,d){return this.to({x:a,y:b},c,d)},Tweener.prototype.wait=function(a){return this.add(new Action(a))},Tweener.prototype.then=function(a){return this.add(new CallAction(a))},Tweener.prototype.setLoop=function(a){return this.loop=a,this};var Action=function(a){this.time=a,this.currentPos=-1};Action.prototype.initialize=function(){this.currentPos=0},Action.prototype.update=function(a){return this.currentPos+=1,this.currentPos===this.time&&this.finalize(a),this.currentPos>=this.time},Action.prototype.finalize=function(){};var CallAction=function(a){Action.call(this,0),this.func=a};CallAction.prototype=Object.create(Action.prototype),CallAction.prototype.update=function(a){return this.func&&this.func.call(a),Action.prototype.update.call(this,a)};var TweenAction=function(a,b,c){Action.call(this,b),this.param=a,this.ease=c||function(a){return a},this.initials={},this.deltas={}};TweenAction.prototype=Object.create(Action.prototype),TweenAction.prototype.initialize=function(a){Action.prototype.initialize.call(this,a);for(var b in this.param)this.initials[b]=a[b],this.deltas[b]=this.param[b]-a[b]},TweenAction.prototype.update=function(a){var b=this.ease(this.currentPos/this.time);for(var c in this.param)a[c]=this.initials[c]+this.deltas[c]*b;return Action.prototype.update.call(this,a)},TweenAction.prototype.finalize=function(a){for(var b in this.param)a[b]=this.param[b]};var Canvas=function(a,b){this.canvas=window.document.createElement("canvas"),this.width=this.canvas.width=a,this.height=this.canvas.height=b,this.context=this.canvas.getContext2d()};Canvas.prototype.set=function(a){var b=this.context;return void 0!==a.color?Util.setStyle(b,a.color):(b.fillStyle=a.fillStyle||"red",b.strokeStyle=a.strokeStyle||"white",b.lineWidth=a.lineWidth||2),this},Canvas.prototype.toTexture=function(){return this.canvas},Canvas.prototype.fillRect=function(a,b,c,d){return this.context.fillRect(a,b,c,d),this},Canvas.prototype.drawRect=function(a,b,c,d){return this.context.fillRect(a,b,c,d),this.context.strokeRect(a,b,c,d),this},Canvas.prototype.drawRoundRect=function(a,b,c,d,e){e=e||10;var f=this.context;return f.beginPath(),f.moveTo(a+e,b),f.lineTo(a+c-e,b),f.arcTo(a+c,b,a+c,b+e,e),f.lineTo(a+c,b+d-e),f.arcTo(a+c,b+d,a+c-e,b+d,e),f.lineTo(a+e,b+d),f.arcTo(a,b+d,a,b+d-e,e),f.lineTo(a,b+e),f.arcTo(a,b,a+e,b,e),f.closePath(),f.fill(),f.stroke(),this},Canvas.prototype.drawCircle=function(a,b,c){return this.context.arc(a,b,c,0,2*Math.PI,!1),this.context.fill(),this.context.stroke(),this},Canvas.prototype.drawPolygon=function(a,b,c,d,e){e=e||0,this.context.beginPath(),this.context.moveTo(a+Math.cos(e)*c,b+Math.sin(e)*c);for(var f=1;d>f;f++){var g=e+2*Math.PI*f/d;this.context.lineTo(a+Math.cos(g)*c,b+Math.sin(g)*c)}this.context.closePath(),this.context.fill(),this.context.stroke()},Canvas.prototype.drawLines=function(){this.context.beginPath(),this.context.moveTo(arguments[0][0],arguments[0][1]);for(var a=1;a<arguments.length;a++)this.context.lineTo(arguments[a][0],arguments[a][1]);this.context.closePath(),this.context.fill(),this.context.stroke()},Canvas.prototype.drawImage=function(){this.context.drawImage.apply(this.context,arguments)},function(){function a(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}Canvas.prototype.stackBlur=function(d){var e=this.width,f=this.height,g=(this.canvas,this.context);if(!(isNaN(d)||1>d)){d|=0;var h;try{try{h=g.getImageData(0,0,e,f)}catch(i){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=g.getImageData(0,0,e,f)}catch(i){throw alert("Cannot access local image"),new Error("unable to access local image data: "+i)}}}catch(i){throw alert("Cannot access image"),new Error("unable to access image data: "+i)}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H=h.data,I=d+d+1,J=e-1,K=f-1,L=d+1,M=L*(L+1)/2,N=new a,O=N;for(l=1;I>l;l++)if(O=O.next=new a,l==L)var P=O;O.next=N;var Q=null,R=null;p=o=0;var S=b[d],T=c[d];for(k=0;f>k;k++){for(y=z=A=B=q=r=s=t=0,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(l=1;L>l;l++)m=o+((l>J?J:l)<<2),q+=(O.r=C=H[m])*(G=L-l),r+=(O.g=D=H[m+1])*G,s+=(O.b=E=H[m+2])*G,t+=(O.a=F=H[m+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next;for(Q=N,R=P,j=0;e>j;j++)H[o+3]=F=t*S>>T,0!=F?(F=255/F,H[o]=(q*S>>T)*F,H[o+1]=(r*S>>T)*F,H[o+2]=(s*S>>T)*F):H[o]=H[o+1]=H[o+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=p+((m=j+d+1)<J?m:J)<<2,y+=Q.r=H[m],z+=Q.g=H[m+1],A+=Q.b=H[m+2],B+=Q.a=H[m+3],q+=y,r+=z,s+=A,t+=B,Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=4;p+=e}for(j=0;e>j;j++){for(z=A=B=y=r=s=t=q=0,o=j<<2,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(n=e,l=1;d>=l;l++)o=n+j<<2,q+=(O.r=C=H[o])*(G=L-l),r+=(O.g=D=H[o+1])*G,s+=(O.b=E=H[o+2])*G,t+=(O.a=F=H[o+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next,K>l&&(n+=e);for(o=j,Q=N,R=P,k=0;f>k;k++)m=o<<2,H[m+3]=F=t*S>>T,F>0?(F=255/F,H[m]=(q*S>>T)*F,H[m+1]=(r*S>>T)*F,H[m+2]=(s*S>>T)*F):H[m]=H[m+1]=H[m+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=j+((m=k+L)<K?m:K)*e<<2,q+=y+=Q.r=H[m],r+=z+=Q.g=H[m+1],s+=A+=Q.b=H[m+2],t+=B+=Q.a=H[m+3],Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=e}return g.putImageData(h,0,0),this}};var b=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]}();var NineleapUtil={gotoLogin:function(){window.location.replace("http://9leap.net/api/login")},isOn9leap:function(){return"r.jsgames.jp"===window.location.hostname
},scoreEntry:function(a,b){if(NineleapUtil.isOn9leap()){var c=window.location.pathname.match(/^\/games\/(\d+)/)[1];window.location.replace(["http://9leap.net/games/",c,"/result","?score=",window.encodeURIComponent(a),"&result=",window.encodeURIComponent(b)].join(""))}else window.location.replace(window.location.href)},getGameId:function(){return NineleapUtil.isOn9leap()?window.location.pathname.match(/^\/games\/(\d+)/)[1]:NineleapUtil.DEBUG_GAME_ID},getMyData:function(a){console.debug("NineleapUtil.getMyData");var b=new Jsonp({url:NineleapUtil.createMyDataURL()});b.onsuccess=function(b){console.debug("NineleapUtil.getMyData success",b),a(null,b)},b.onerror=function(b){a(b)},b.send()},postMyData:function(a,b){var c=new Xhr({type:"POST",url:NineleapUtil.createURL("user_memory.json"),data:"json="+JSON.stringify(a),withCredentials:!0,requestHeader:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},async:!1});c.onsuccess=function(){console.info("postMyData success."),b&&b(null)},c.onerror=function(a){console.error("error at NineleapUtil.postMyData",a),b&&b(new Error(a))},c.send()},deleteMyData:function(a){NineleapUtil.postMyData(null,a)},createURL:function(){for(var a=["http://9leap.net/api/memory/",NineleapUtil.getGameId()+"/"],b=0,c=arguments.length;c>b;b++)a.push(arguments[b]);return a.join("")},createMyDataURL:function(){return NineleapUtil.createURL("user_memory.json")},createUserDataURL:function(a){return NineleapUtil.createURL("u/",a+".json")},createRecentDataURL:function(a){return a=a||30,NineleapUtil.createURL("recent_memories.json","?max="+a)},createFriendDataURL:function(a){return a=a||30,NineleapUtil.createURL("friends_memories.json","?max="+a)},createRankingDataURL:function(a){return a=a||30,NineleapUtil.createURL("ranking_memories.json","?max="+a)}};NineleapUtil.DEBUG_GAME_ID="1888";var Loading=function(){Object2d.call(this),this.setPosition(.5*SC_W,.5*SC_H),this.bg=(new Object2d).addChildTo(this),this.bg.draw=function(a){a.globalCompositeOperation="source-over",a.fillStyle="rgba(0, 0, 0, 0.5)",a.fillRect(-SC_W,-SC_H,2*SC_W,2*SC_H)},new Label("loading...",20,200).addChildTo(this);for(var a=0,b=0;12>b;b++)new Rect(30*b,20,20).setPosition(50*Math.cos(a),50*Math.sin(a)).addChildTo(this.bg).glow().update=function(){this.rotation+=.1},a+=2*Math.PI/12};Loading.prototype=Object.create(Object2d.prototype),Loading.prototype.update=function(a){this.bg.rotation+=.03,this.scaleX=this.scaleY=1+.2*Math.sin(.1*a.frame)};var Explosion=function(a,b,c){Node.call(this),this.x=a,this.y=b,this.dirCount=5,this.spdRate=c||1,this.particleClass=ExplosionPerticle};Explosion.prototype=Object.create(Node.prototype),Explosion.prototype.update=function(){0===this.children.length&&this.remove()},Explosion.prototype.onadded=function(){for(var a=0;a<this.dirCount;a++)for(var b=Explosion.VEL[parseInt(Math.random()*Explosion.VEL.length)],c=this.speed(),d=0;5>d;d++){var e=new this.particleClass;e&&(e.x=this.x,e.y=this.y,e.scaleX=e.scaleY=1+.2*(5-d),e.vx=b.x*(1+d)*c,e.vy=b.y*(1+d)*c,e.addChildTo(this))}},Explosion.prototype.speed=function(){return.8+1.2*Math.random()*this.spdRate},Explosion.VEL=Util.range(0,16).map(function(a){return{x:Math.cos(2*Math.PI*a/16),y:Math.sin(2*Math.PI*a/16)}}),Explosion.addTarget=null;var ExplosionPerticle=function(){Sprite.call(this,ExplosionPerticle.TEXTURE),this.alpha=.5,this.vx=0,this.vy=0};ExplosionPerticle.prototype=Object.create(Sprite.prototype),ExplosionPerticle.prototype.update=function(){this.x+=this.vx,this.y+=this.vy,this.vx*=.95,this.vy*=.95,this.alpha-=.01,this.alpha<0&&this.remove()},ExplosionPerticle.TEXTURE=function(){return new Rect(10,20,20).texture}();
//# sourceMappingURL=plib.min.js.map