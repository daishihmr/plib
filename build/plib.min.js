/*
 * plib.js v0.0.0
 * http://tomcat.dev7.jp/gitbucket/daishi/plib
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
 
var SC_W=SC_W||320,SC_H=SC_H||320,SC_ASPECT=SC_W/SC_H,SC_ASPECT_INV=SC_H/SC_W,IS_MOBILE=-1!==window.navigator.userAgent.indexOf("iPhone")||-1!==window.navigator.userAgent.indexOf("Android");HTMLCanvasElement.prototype.getContext2d=function(){var t=this.getContext("2d");return t};var Application=function(t,e){Application.INSTANCE=this,this.stats=null,"r.jsgames.jp"!==window.location.host&&window.Stats&&(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",window.document.body.appendChild(this.stats.domElement));var n=window.document.createElement("div");window.document.body.appendChild(n),n.style.position="absolute",n.style.top=n.style.left=0,this.layerCount=t||1,this.mainLayerIndex=e||0,this.layers=[];for(var i=0;this.layerCount>i;i++)this.addNewLayer();this._canvasLeft=0,this._canvasTop=0,this._canvasScale=0;var o=function(){if(n.style.width=window.innerWidth+"px",n.style.height=window.innerHeight+"px",SC_ASPECT>window.innerWidth/window.innerHeight){this._canvasLeft=0,this._canvasTop=.5*(window.innerHeight-window.innerWidth*SC_ASPECT_INV),this._canvasScale=SC_W/window.innerWidth;for(var t=0;this.layerCount>t;t++){var e=this.layers[t].style;e.width=window.innerWidth+"px",e.height=window.innerWidth*SC_ASPECT_INV+"px",e.left=this._canvasLeft+"px",e.top=this._canvasTop+"px"}}else{this._canvasLeft=.5*(window.innerWidth-window.innerHeight*SC_ASPECT),this._canvasTop=0,this._canvasScale=SC_H/window.innerHeight;for(var t=0;this.layerCount>t;t++){var e=this.layers[t].style;e.width=window.innerHeight*SC_ASPECT+"px",e.height=window.innerHeight+"px",e.left=this._canvasLeft+"px",e.top=this._canvasTop+"px"}}}.bind(this);o(),window.addEventListener("resize",o,!1),this.context=this.layers[this.mainLayerIndex].getContext2d(),this.pointing={isStart:!1,isPointing:!1,isEnd:!1,x:0,y:0,beforeX:0,beforeY:0,deltaX:0,deltaY:0},this.keyboard={up:!1,down:!1,left:!1,right:!1,z:!1,x:!1,angles:{10:{x:Math.cos(0*Math.PI),y:Math.sin(0*Math.PI)},1010:{x:Math.cos(.25*Math.PI),y:Math.sin(.25*Math.PI)},1e3:{x:Math.cos(.5*Math.PI),y:Math.sin(.5*Math.PI)},1001:{x:Math.cos(.75*Math.PI),y:Math.sin(.75*Math.PI)},1:{x:Math.cos(1*Math.PI),y:Math.sin(1*Math.PI)},101:{x:Math.cos(1.25*Math.PI),y:Math.sin(1.25*Math.PI)},100:{x:Math.cos(1.5*Math.PI),y:Math.sin(1.5*Math.PI)},110:{x:Math.cos(1.75*Math.PI),y:Math.sin(1.75*Math.PI)}},angle:function(){return this.angles[1e3*this.down+100*this.up+10*this.right+1*this.left]}},this._beforeTouching=!1,this._touching=!1,window.document.body.addEventListener("touchstart",function(t){var e=t.touches[0];this._touching=!0,e&&(this.pointing.x=(e.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(e.clientY-this._canvasTop)*this._canvasScale),t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchmove",function(t){var e=t.touches[0];this._touching=!0,e&&(this.pointing.x=(e.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(e.clientY-this._canvasTop)*this._canvasScale),t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchend",function(t){var e=t.touches[0];this._touching=!1,e&&(this.pointing.x=(e.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(e.clientY-this._canvasTop)*this._canvasScale),t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.addEventListener("mousedown",function(t){this._touching=!0,this.pointing.x=(t.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(t.clientY-this._canvasTop)*this._canvasScale,t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.addEventListener("mousemove",function(t){this.pointing.x=(t.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(t.clientY-this._canvasTop)*this._canvasScale,t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.addEventListener("mouseup",function(t){this._touching=!1,this.pointing.x=(t.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(t.clientY-this._canvasTop)*this._canvasScale,t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation()}.bind(this),!0),window.addEventListener("keydown",function(t){switch(t.keyCode){case 38:this.keyboard.up=!0;break;case 37:this.keyboard.left=!0;break;case 39:this.keyboard.right=!0;break;case 40:this.keyboard.down=!0;break;case 88:this.keyboard.x=!0;break;case 90:this.keyboard.z=!0}}.bind(this),!1),window.addEventListener("keyup",function(t){switch(t.keyCode){case 38:this.keyboard.up=!1;break;case 37:this.keyboard.left=!1;break;case 39:this.keyboard.right=!1;break;case 40:this.keyboard.down=!1;break;case 88:this.keyboard.x=!1;break;case 90:this.keyboard.z=!1}}.bind(this),!1),this.frame=0,this.currentScene=new Scene,this.sceneStack=[this.currentScene];var s=function(){null!==this.stats&&this.stats.update(),this.update(),this.draw(),this.frame+=1,window.requestAnimationFrame(s)}.bind(this);window.requestAnimationFrame(s)};Application.prototype.end=function(){},Application.prototype.update=function(){var t=this.pointing;!this._beforeTouching&&this._touching?(t.isStart=!0,t.isPointing=!1,t.isEnd=!1,t.deltaX=0,t.deltaY=0):this._beforeTouching&&this._touching?(t.isStart=!1,t.isPointing=!0,t.isEnd=!1,t.deltaX=t.x-t.beforeX,t.deltaY=t.y-t.beforeY):this._beforeTouching&&!this._touching?(t.isStart=!1,t.isPointing=!1,t.isEnd=!0,t.deltaX=t.x-t.beforeX,t.deltaY=t.y-t.beforeY):(t.isStart=!1,t.isPointing=!1,t.isEnd=!1,t.deltaX=t.x-t.beforeX,t.deltaY=t.y-t.beforeY),this._beforeTouching=this._touching,this.currentScene&&this.currentScene._update(this),t.beforeX=t.x,t.beforeY=t.y},Application.prototype.addNewLayer=function(){var t=window.document.createElement("canvas");window.document.body.appendChild(t),t.style.position="absolute",t.width=SC_W,t.height=SC_H,this.layers.push(t)},Application.prototype.draw=function(){this.context.clearRect(0,0,SC_W,SC_H);for(var t=0,e=this.sceneStack.length;e>t;t++)this.sceneStack[t]._draw(this.context)},Application.prototype.replaceScene=function(t){this.currentScene&&(this.currentScene.app=null,this.currentScene.onexit()),this.sceneStack.pop(),this.sceneStack.push(t),this.currentScene=t,this.currentScene.app=this,this.currentScene.onenter()},Application.prototype.pushScene=function(t){this.sceneStack.length>0&&this.sceneStack[this.sceneStack.length-1].onexit(),this.sceneStack.push(t),t.app=this,this.currentScene=t,t.onenter()},Application.prototype.popScene=function(){var t=this.sceneStack.pop();t&&(t.onexit(),t.app=null,this.sceneStack.length>0?(this.currentScene=this.sceneStack[this.sceneStack.length-1],this.currentScene.onenter()):this.currentScene=null)},Application.INSTANCE=null;var Node=function(){this.parent=null,this.children=[],this.frame=0,this.visible=!0};Node.prototype.addChild=function(t){t.parent=this,this.children.push(t),t.onadded()},Node.prototype.addChildTo=function(t){return t.addChild(this),this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);e>=0&&(t.parent=null,this.children.splice(e,1),t.onremoved())},Node.prototype.remove=function(){return null!==this.parent&&this.parent.removeChild(this),this},Node.prototype._update=function(t){this.update(t);for(var e=[].concat(this.children),n=0,i=e.length;i>n;n++)e[n]._update(t);this.frame+=1},Node.prototype._draw=function(t){if(t.save(),this.visible){this.predraw(t),this.draw(t);for(var e=0,n=this.children.length;n>e;e++)this.children[e]._draw(t)}t.restore()},Node.prototype.update=function(){},Node.prototype.predraw=function(){},Node.prototype.draw=function(){},Node.prototype.onadded=function(){},Node.prototype.onremoved=function(){};var Object2d=function(){Node.call(this),this.width=0,this.height=0,this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.originX=.5,this.originY=.5};Object2d.prototype=Object.create(Node.prototype),Object2d.prototype.predraw=function(t){t.translate(this.x,this.y),t.rotate(this.rotation),t.scale(this.scaleX,this.scaleY)},Object2d.prototype.setPosition=function(t,e){return this.x=t,this.y=e,this},Object2d.prototype.setOrigin=function(t,e){return this.originX=t,this.originY=e,this},Object2d.prototype.setScale=function(t,e){return 1===arguments.length&&(e=t),this.scaleX=t,this.scaleY=e,this},Object2d.prototype.setRotation=function(t){return this.rotation=t,this};var Menu=function(){Node.call(this),this.selected=null,this.enabled=!0};Menu.prototype=Object.create(Node.prototype),Menu.prototype.update=function(t){if(this.enabled)for(var e=t.pointing,n=0,i=this.children.length;i>n;n++){var o=this.children[n];if(o.scaleX=o.scaleY=this.selected===o?1+.1*Math.sin(.3*t.frame):1,e.isEnd&&o.isHitPoint(e)){this.selected===o?this.onSelectItem(o):(this.selected=o,this.onPreSelectItem(o));break}}},Menu.prototype.enable=function(){this.enabled=!0},Menu.prototype.disable=function(){this.enabled=!1;for(var t=0,e=this.children.length;e>t;t++){var n=this.children[t];n.scaleX=n.scaleY=1}},Menu.prototype.onPreSelectItem=function(){},Menu.prototype.onSelectItem=function(){};var Layer=function(t,e){Node.call(this),this.canvas=t,t.width=SC_W,t.height=SC_H,this.context=t.getContext2d(),this.drawRate=e};Layer.prototype=Object.create(Node.prototype),Layer.prototype._draw=function(){if(0===this.frame%this.drawRate){this.context.clearRect(0,0,SC_W,SC_H),this.context.save(),this.draw(this.context);for(var t=0,e=this.children.length;e>t;t++)this.children[t]._draw(this.context);this.context.restore()}};var Scene=function(){Node.call(this),this.app=null};Scene.prototype=Object.create(Node.prototype),Scene.prototype.onenter=function(){},Scene.prototype.onexit=function(){};var Assets={},AssetLoadScene=function(t,e){Scene.call(this),this.nextScene=e,this.allCount=0;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].match(/\.\w+/);if(i)switch(i[0]){case".mp3":this._loadAudio(n,t[n])}this.allCount+=1}this.loadedCount=0;var o=this.label=new Label("ロード中...",20,240);o.x=.5*SC_W,o.y=.5*SC_H,o.addChildTo(this)};AssetLoadScene.prototype=Object.create(Scene.prototype),AssetLoadScene.prototype._loadAudio=function(t,e){var n=new Xhr({url:e,responseType:"arraybuffer"});n.onsuccess=function(e){var n=new Sound(e),i=this;n.onload=function(){Assets[t]=this,i.loadedCount+=1}}.bind(this),n.send()},AssetLoadScene.prototype.update=function(t){this.label.scaleX=this.label.scaleY=1+.2*Math.sin(.1*t.frame),this.loadedCount===this.allCount&&t.replaceScene(this.nextScene)};var Xhr=function(t){this.param=t;var e=this,n=this.xhr=new XMLHttpRequest;n.onreadystatechange=function(){4===this.readyState&&(200===this.status?e.onsuccess(this.response):e.onerror(this),e.oncomplete(this))};var i=t.async;if(void 0===i&&(i=!0),n.open(t.type||"GET",t.url,i),t.withCredentials&&(n.withCredentials=t.withCredentials),t.requestHeader)for(var o in t.requestHeader)t.requestHeader.hasOwnProperty(o)&&n.setRequestHeader(o,t.requestHeader[o]);t.responseType&&(n.responseType=t.responseType)};Xhr.prototype.send=function(){console.debug("xhr send to "+this.param.url),this.param.data?this.xhr.send(this.param.data):this.xhr.send()},Xhr.prototype.onsuccess=function(){},Xhr.prototype.onerror=function(){},Xhr.prototype.oncomplete=function(){};var Jsonp=function(t){this.param=t,this.callbackName="_jsonpcallback_"+(new Date).getTime()+parseInt(1e3*Math.random());var e=this;window[this.callbackName]=function(t){delete window[e.callbackName],window.document.body.removeChild(e.script),e.onsuccess(t)}};Jsonp.prototype.send=function(){console.debug("jsonp send"),this.script=window.document.createElement("script"),this.script.src=this.param.data?this.param.url+"?"+this.param.data+"&callback="+this.callbackName:this.param.url+"?callback="+this.callbackName;try{window.document.body.appendChild(this.script)}catch(t){this.onerror(t)}},Jsonp.prototype.onsuccess=function(){},Jsonp.prototype.onerror=function(){},Jsonp.prototype.oncomplete=function(){};var Sound=function(t){if(this.buffer=null,this.source=null,this.gainNode=null,null===Sound.CONTEXT)throw Error("webkitAudioContext is not defined.");t instanceof ArrayBuffer?Sound.CONTEXT.decodeAudioData(t,function(t){this.buffer=t,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload()}.bind(this)):t instanceof AudioBuffer&&(this.buffer=t,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload())};Sound.prototype=Object.create(Object.prototype,{volume:{get:function(){return this.gainNode.gain.value},set:function(t){this.gainNode.gain.value=t}},loop:{get:function(){return this.source.loop},set:function(t){this.source.loop=t}},loopStart:{get:function(){return this.source.loopStart},set:function(t){this.source.loopStart=t}},loopEnd:{get:function(){return this.source.loopEnd},set:function(t){this.source.loopEnd=t}}}),Sound.prototype.onload=function(){},Sound.prototype.start=function(){this.source.start(0)},Sound.prototype.play=Sound.prototype.start,Sound.prototype.stop=function(){this.source.stop(0),this.source.disconnect();var t=this.gainNode.gain.value;this.source=Sound.CONTEXT.createBufferSource(),this.gainNode.gain.value=t,this.source.buffer=this.buffer,this.source.connect(Sound.CONTEXT.destination)},Sound.prototype.clone=function(){var t=new Sound(this.buffer);return t.volume=this.volume,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t},Sound.CONTEXT=null,window.webkitAudioContext?Sound.CONTEXT=new webkitAudioContext:window.mozAudioContext?Sound.CONTEXT=new mozAudioContext:window.AudioContext&&(Sound.CONTEXT=new AudioContext);var SoundEngine={};SoundEngine.bgm=null,SoundEngine.bgmName=null,SoundEngine.playing={},SoundEngine.playSE=function(t){if(Assets[t]){if(SoundEngine.playing[t]===Application.INSTANCE.frame)return;SoundEngine.playing[t]=Application.INSTANCE.frame;var e=Assets[t].clone();e.volume=OptionSettings.seVolume,e.start()}},SoundEngine.startBgm=function(t){SoundEngine.bgmName!==t&&(SoundEngine.stopBgm(),Assets[t]&&(SoundEngine.bgmName=t,SoundEngine.bgm=Assets[t].clone(),SoundEngine.bgm.loop=!0,SoundEngine.bgm.volume=OptionSettings.bgmVolume,SoundEngine.bgm.start()))},SoundEngine.stopBgm=function(){SoundEngine.bgm&&(SoundEngine.bgm.stop(),SoundEngine.bgm=null,SoundEngine.bgmName=null)};var Sprite=function(t){Object2d.call(this),this.texture=t,this.width=t.width,this.height=t.height,this.alpha=1,this.blendMode="lighter"};Sprite.prototype=Object.create(Object2d.prototype),Sprite.prototype.draw=function(t){t.globalAlpha=this.alpha,t.globalCompositeOperation=this.blendMode,t.drawImage(this.texture,-this.width*this.originX,-this.height*this.originY)},Sprite.prototype.isHitPoint=function(t){var e=.5*this.width*this.scaleX,n=.5*this.height*this.scaleY;return this.x-e<=t.x&&t.x<this.x+e&&this.y-n<=t.y&&t.y<this.y+n};var Rect=function(t,e,n){var i=new Canvas(e,n).set({color:t}).drawRect(2,2,e-4,n-4).toTexture();Sprite.call(this,i)};Rect.prototype=Object.create(Sprite.prototype);var RoundRect=function(t,e,n){var i=new Canvas(e,n).set({color:t}).drawRoundRect(2,2,e-4,n-4).toTexture();Sprite.call(this,i)};RoundRect.prototype=Object.create(Sprite.prototype);var Circle=function(t,e){this.radius=e;var n=new Canvas(2*e,2*e).set({color:t}).drawCircle(e,e,e-2).toTexture();Sprite.call(this,n)};Circle.prototype=Object.create(Sprite.prototype);var Polygon=function(t,e,n){var i=window.document.createElement("canvas");i.width=2*e,i.height=2*e;var o=i.getContext2d();Util.setStyle(o,t),o.beginPath(),o.moveTo(e+Math.cos(0)*(e-2),e+Math.sin(0)*(e-2));for(var s=1;n>s;s++){var a=2*Math.PI*s/n;o.lineTo(e+Math.cos(a)*(e-2),e+Math.sin(a)*(e-2))}o.closePath(),o.fill(),o.stroke(),Sprite.call(this,i)};Polygon.prototype=Object.create(Sprite.prototype);var RandomPolygon=function(t,e,n){var i=window.document.createElement("canvas");i.width=2*e,i.height=2*e;var o=i.getContext2d();Util.setStyle(o,t);var s=(e-2)*(.5+.5*Math.random());o.beginPath(),o.moveTo(e+Math.cos(0)*s,e+Math.sin(0)*s);for(var a=1;n>a;a++){var r=2*Math.PI*a/n;s=(e-2)*(.5+.5*Math.random()),o.lineTo(e+Math.cos(r)*s,e+Math.sin(r)*s)}o.closePath(),o.fill(),o.stroke(),Sprite.call(this,i)};RandomPolygon.prototype=Object.create(Sprite.prototype);var Fighter=function(t,e,n){var i=new Canvas(e,n),o=i.context;Util.setStyle(o,220),o.beginPath(),o.moveTo(.35*e,.4*n),o.lineTo(.4*e,.8*n),o.lineTo(.2*e,.9*n),o.closePath(),o.fill(),o.stroke(),o.beginPath(),o.moveTo(.65*e,.4*n),o.lineTo(.8*e,.9*n),o.lineTo(.6*e,.8*n),o.closePath(),o.fill(),o.stroke(),o.beginPath(),o.moveTo(.5*e,.1*n),o.lineTo(.65*e,.7*n),o.lineTo(.35*e,.7*n),o.closePath(),o.fill(),o.stroke(),Sprite.call(this,i.toTexture())};Fighter.prototype=Object.create(Sprite.prototype);var Label=function(t,e,n){this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this._text=t,this._fontSize=e||24,this.setColor(n||0);var i=this.updateText();Sprite.call(this,i)};Label.prototype=Object.create(Sprite.prototype,{text:{get:function(){return this._text},set:function(t){this.setText(t)}},fontSize:{get:function(){return this._fontSize},set:function(t){this.setFontSize(t)}}}),Label.prototype.setColor=function(t){this.fillStyle="hsla("+t+", 50%, 80%, 1.0)"},Label.prototype.setText=function(t){this._text=t,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.setFontSize=function(t){this._fontSize=t,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.updateText=function(){var t=window.document.createElement("canvas"),e=t.getContext2d(!0);e.font=""+this._fontSize+"px 'uni'";var n=e.measureText(this._text);return t.width=n.width+5,t.height=this._fontSize,e.font=""+this._fontSize+"px 'uni'",e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.fillStyle,e.lineWidth=2,e.fillText(this._text,.5*t.width,.5*t.height),t};var Util={style:function(t){return{fillStyle:"hsla("+t+", 80%, 20%, 0.5)",strokeStyle:"hsla("+t+", 50%, 80%, 1.0)",lineWidth:2}},setStyle:function(t,e){var n=this.style(e);t.fillStyle=n.fillStyle,t.strokeStyle=n.strokeStyle,t.lineWidth=n.lineWidth},linearGradient:function(t,e,n,i,o){for(var s=window.document.createElement("canvas").getContext2d(),a=s.createLinearGradient(t,e,n,i),r=0;o.length>r;r++)a.addColorStop(o[r].offset,o[r].color);return a},radialGradient:function(t,e,n,i,o,s,a){for(var r=window.document.createElement("canvas").getContext2d(),c=r.createRadialGradient(t,e,n,i,o,s),h=0;a.length>h;h++)c.addColorStop(a[h].offset,a[h].color);return c},range:function(t,e){for(var n=[],i=t;e>i;i++)n.push(i);return n},curry:function(t){return function e(n){return n.length<t.length?function(t){return e(n.concat([t]))}:t.apply(void 0,n)}([])},rand:function(t,e){return t+Math.random()*(e-t)},randi:function(t,e){return parseInt(t+Math.random()*(e-t))},clamp:function(t,e,n){return Math.max(e,Math.min(t,n))}},Http={queryParameter:function(t){var e="",n=!0;for(var i in t)t.hasOwnProperty(i)&&(n||(e+="&"),e+=encodeURI(i)+"="+encodeURI(t[i]),n=!1);return e}},Tweener=function(t){Node.call(this),this.target=t,this.actions=[],this.actionPointer=0,this.loop=!1,this.addChildTo(t)};Tweener.prototype=Object.create(Node.prototype),Tweener.prototype.update=function(){var t=this.actions[this.actionPointer];void 0!==t&&(0>t.currentPos&&t.initialize(this.target),t.update(this.target)&&(this.actionPointer+=1,this.actions.length===this.actionPointer&&(this.loop?this.actionPointer=0:this.remove())))},Tweener.prototype.add=function(t){return this.actions.push(t),this},Tweener.prototype.to=function(t,e,n){return this.add(new TweenAction(t,e,n))},Tweener.prototype.moveTo=function(t,e,n,i){return this.to({x:t,y:e},n,i)},Tweener.prototype.wait=function(t){return this.add(new Action(t))},Tweener.prototype.then=function(t){return this.add(new CallAction(t))},Tweener.prototype.setLoop=function(t){return this.loop=t,this};var Action=function(t){this.time=t,this.currentPos=-1};Action.prototype.initialize=function(){this.currentPos=0},Action.prototype.update=function(t){return this.currentPos+=1,this.currentPos===this.time&&this.finalize(t),this.currentPos>=this.time},Action.prototype.finalize=function(){};var CallAction=function(t){Action.call(this,0),this.func=t};CallAction.prototype=Object.create(Action.prototype),CallAction.prototype.update=function(t){return this.func&&this.func.call(t),Action.prototype.update.call(this,t)};var TweenAction=function(t,e,n){Action.call(this,e),this.param=t,this.ease=n||function(t){return t},this.initials={},this.deltas={}};TweenAction.prototype=Object.create(Action.prototype),TweenAction.prototype.initialize=function(t){Action.prototype.initialize.call(this,t);for(var e in this.param)this.initials[e]=t[e],this.deltas[e]=this.param[e]-t[e]},TweenAction.prototype.update=function(t){var e=this.ease(this.currentPos/this.time);for(var n in this.param)t[n]=this.initials[n]+this.deltas[n]*e;return Action.prototype.update.call(this,t)},TweenAction.prototype.finalize=function(t){for(var e in this.param)t[e]=this.param[e]};var Canvas=function(t,e){this.canvas=window.document.createElement("canvas"),this.width=this.canvas.width=t,this.height=this.canvas.height=e,this.context=this.canvas.getContext2d()};Canvas.prototype.set=function(t){var e=this.context;return void 0!==t.color?Util.setStyle(e,t.color):(e.fillStyle=t.fillStyle||"red",e.strokeStyle=t.strokeStyle||"white",e.lineWidth=t.lineWidth||2),this},Canvas.prototype.toTexture=function(){return this.canvas},Canvas.prototype.fillRect=function(t,e,n,i){return this.context.fillRect(t,e,n,i),this},Canvas.prototype.drawRect=function(t,e,n,i){return this.context.fillRect(t,e,n,i),this.context.strokeRect(t,e,n,i),this},Canvas.prototype.drawRoundRect=function(t,e,n,i,o){o=o||10;var s=this.context;return s.beginPath(),s.moveTo(t+o,e),s.lineTo(t+n-o,e),s.arcTo(t+n,e,t+n,e+o,o),s.lineTo(t+n,e+i-o),s.arcTo(t+n,e+i,t+n-o,e+i,o),s.lineTo(t+o,e+i),s.arcTo(t,e+i,t,e+i-o,o),s.lineTo(t,e+o),s.arcTo(t,e,t+o,e,o),s.closePath(),s.fill(),s.stroke(),this},Canvas.prototype.drawCircle=function(t,e,n){return this.context.arc(t,e,n,0,2*Math.PI,!1),this.context.fill(),this.context.stroke(),this},Canvas.prototype.drawPolygon=function(t,e,n,i,o){o=o||0,this.context.beginPath(),this.context.moveTo(t+Math.cos(o)*n,e+Math.sin(o)*n);for(var s=1;i>s;s++){var a=o+2*Math.PI*s/i;this.context.lineTo(t+Math.cos(a)*n,e+Math.sin(a)*n)}this.context.closePath(),this.context.fill(),this.context.stroke()},Canvas.prototype.drawLines=function(){this.context.beginPath(),this.context.moveTo(arguments[0][0],arguments[0][1]);for(var t=1;arguments.length>t;t++)this.context.lineTo(arguments[t][0],arguments[t][1]);this.context.closePath(),this.context.fill(),this.context.stroke()};var NineleapUtil={gotoLogin:function(){window.location.replace("http://9leap.net/api/login")},isOn9leap:function(){return"r.jsgames.jp"===window.location.hostname},scoreEntry:function(t,e){if(NineleapUtil.isOn9leap()){var n=window.location.pathname.match(/^\/games\/(\d+)/)[1];window.location.replace(["http://9leap.net/games/",n,"/result","?score=",window.encodeURIComponent(t),"&result=",window.encodeURIComponent(e)].join(""))}else window.location.replace(window.location.href)},getGameId:function(){return NineleapUtil.isOn9leap()?window.location.pathname.match(/^\/games\/(\d+)/)[1]:NineleapUtil.DEBUG_GAME_ID},getMyData:function(t){console.debug("NineleapUtil.getMyData");var e=new Jsonp({url:NineleapUtil.createMyDataURL()});e.onsuccess=function(e){console.debug("NineleapUtil.getMyData success",e),t(null,e)},e.onerror=function(e){t(e)},e.send()},postMyData:function(t,e){if(!NineleapUtil.isOn9leap())return e("not on 9leap.net"),void 0;var n=new Xhr({type:"POST",url:NineleapUtil.createURL("user_memory.json"),data:"json="+JSON.stringify(t),withCredentials:!0,requestHeader:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},async:!1});n.onsuccess=function(){e&&e(null)},n.onerror=function(t){console.error("error at NineleapUtil.postMyData"),console.dir(t),e&&e(Error(t))},n.send()},createURL:function(){for(var t=["http://9leap.net/api/memory/",NineleapUtil.getGameId()+"/"],e=0,n=arguments.length;n>e;e++)t.push(arguments[e]);return t.join("")},createMyDataURL:function(){return NineleapUtil.createURL("user_memory.json")},createUserDataURL:function(t){return NineleapUtil.createURL("u/",t+".json")},createRecentDataURL:function(t){return t=t||30,NineleapUtil.createURL("recent_memories.json","?max="+t)},createFriendDataURL:function(t){return t=t||30,NineleapUtil.createURL("friends_memories.json","?max="+t)},createRankingDataURL:function(t){return t=t||30,NineleapUtil.createURL("ranking_memories.json","?max="+t)}};NineleapUtil.DEBUG_GAME_ID="1888";