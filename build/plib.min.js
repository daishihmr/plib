/*
 * plib.js v0.0.0
 * http://tomcat.dev7.jp/gitbucket/daishi/plib
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
 
var SC_W=SC_W||320,SC_H=SC_H||320,SC_ASPECT=SC_W/SC_H,SC_ASPECT_INV=SC_H/SC_W,IS_MOBILE=-1!==window.navigator.userAgent.indexOf("iPhone")||-1!==window.navigator.userAgent.indexOf("Android");HTMLCanvasElement.prototype.getContext2d=function(a){a=!!a;var b=this.getContext("2d");return b.hasOwnProperty("imageSmoothingEnabled")?b.imageSmoothingEnabled=a:b.hasOwnProperty("mozImageSmoothingEnabled")?b.mozImageSmoothingEnabled=a:b.hasOwnProperty("webkitImageSmoothingEnabled")&&(b.webkitImageSmoothingEnabled=a),b};var Application=function(a,b){Application.INSTANCE=this,this.stats=null,"r.jsgames.jp"!==window.location.host&&window.Stats&&(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",window.document.body.appendChild(this.stats.domElement));var c=window.document.createElement("div");window.document.body.appendChild(c),c.style.position="absolute",c.style.top=c.style.left=0,this.layerCount=a||1,this.mainLayerIndex=b||0,this.layers=[];for(var d=0;d<this.layerCount;d++)this.addNewLayer();this._canvasLeft=0,this._canvasTop=0,this._canvasScale=0;var e=function(){if(c.style.width=window.innerWidth+"px",c.style.height=window.innerHeight+"px",window.innerWidth/window.innerHeight<SC_ASPECT){this._canvasLeft=0,this._canvasTop=.5*(window.innerHeight-window.innerWidth*SC_ASPECT_INV),this._canvasScale=SC_W/window.innerWidth;for(var a=0;a<this.layerCount;a++){var b=this.layers[a].style;b.width=window.innerWidth+"px",b.height=window.innerWidth*SC_ASPECT_INV+"px",b.left=this._canvasLeft+"px",b.top=this._canvasTop+"px"}}else{this._canvasLeft=.5*(window.innerWidth-window.innerHeight*SC_ASPECT),this._canvasTop=0,this._canvasScale=SC_H/window.innerHeight;for(var a=0;a<this.layerCount;a++){var b=this.layers[a].style;b.width=window.innerHeight*SC_ASPECT+"px",b.height=window.innerHeight+"px",b.left=this._canvasLeft+"px",b.top=this._canvasTop+"px"}}}.bind(this);e(),window.addEventListener("resize",e,!1),this.context=this.layers[this.mainLayerIndex].getContext2d(),this.pointing={isStart:!1,isPointing:!1,isEnd:!1,x:0,y:0,beforeX:0,beforeY:0,deltaX:0,deltaY:0},this.keyboard={up:!1,down:!1,left:!1,right:!1,z:!1,x:!1,angles:{10:{x:Math.cos(0*Math.PI),y:Math.sin(0*Math.PI)},1010:{x:Math.cos(.25*Math.PI),y:Math.sin(.25*Math.PI)},1e3:{x:Math.cos(.5*Math.PI),y:Math.sin(.5*Math.PI)},1001:{x:Math.cos(.75*Math.PI),y:Math.sin(.75*Math.PI)},1:{x:Math.cos(1*Math.PI),y:Math.sin(1*Math.PI)},101:{x:Math.cos(1.25*Math.PI),y:Math.sin(1.25*Math.PI)},100:{x:Math.cos(1.5*Math.PI),y:Math.sin(1.5*Math.PI)},110:{x:Math.cos(1.75*Math.PI),y:Math.sin(1.75*Math.PI)}},angle:function(){return this.angles[1e3*this.down+100*this.up+10*this.right+1*this.left]}},this._beforeTouching=!1,this._touching=!1,window.document.body.addEventListener("touchstart",function(a){var b=a.touches[0];this._touching=!0,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchmove",function(a){var b=a.touches[0];this._touching=!0,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.document.body.addEventListener("touchend",function(a){var b=a.touches[0];this._touching=!1,b&&(this.pointing.x=(b.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(b.clientY-this._canvasTop)*this._canvasScale),a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mousedown",function(a){this._touching=!0,this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mousemove",function(a){this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("mouseup",function(a){this._touching=!1,this.pointing.x=(a.clientX-this._canvasLeft)*this._canvasScale,this.pointing.y=(a.clientY-this._canvasTop)*this._canvasScale,a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation()}.bind(this),!0),window.addEventListener("keydown",function(a){switch(a.keyCode){case 38:this.keyboard.up=!0;break;case 37:this.keyboard.left=!0;break;case 39:this.keyboard.right=!0;break;case 40:this.keyboard.down=!0;break;case 88:this.keyboard.x=!0;break;case 90:this.keyboard.z=!0}}.bind(this),!1),window.addEventListener("keyup",function(a){switch(a.keyCode){case 38:this.keyboard.up=!1;break;case 37:this.keyboard.left=!1;break;case 39:this.keyboard.right=!1;break;case 40:this.keyboard.down=!1;break;case 88:this.keyboard.x=!1;break;case 90:this.keyboard.z=!1}}.bind(this),!1),this.frame=0,this.currentScene=new Scene,this.sceneStack=[this.currentScene];var f=function(){null!==this.stats&&this.stats.update(),this.update(),this.draw(),this.frame+=1,window.requestAnimationFrame(f)}.bind(this);window.requestAnimationFrame(f)};Application.prototype.end=function(){},Application.prototype.update=function(){var a=this.pointing;!this._beforeTouching&&this._touching?(a.isStart=!0,a.isPointing=!1,a.isEnd=!1,a.deltaX=0,a.deltaY=0):this._beforeTouching&&this._touching?(a.isStart=!1,a.isPointing=!0,a.isEnd=!1,a.deltaX=a.x-a.beforeX,a.deltaY=a.y-a.beforeY):this._beforeTouching&&!this._touching?(a.isStart=!1,a.isPointing=!1,a.isEnd=!0,a.deltaX=a.x-a.beforeX,a.deltaY=a.y-a.beforeY):(a.isStart=!1,a.isPointing=!1,a.isEnd=!1,a.deltaX=a.x-a.beforeX,a.deltaY=a.y-a.beforeY),this._beforeTouching=this._touching,this.currentScene&&this.currentScene._update(this),a.beforeX=a.x,a.beforeY=a.y},Application.prototype.addNewLayer=function(){var a=window.document.createElement("canvas");window.document.body.appendChild(a),a.style.position="absolute",a.width=SC_W,a.height=SC_H,this.layers.push(a)},Application.prototype.draw=function(){this.context.clearRect(0,0,SC_W,SC_H);for(var a=0,b=this.sceneStack.length;b>a;a++)this.sceneStack[a]._draw(this.context)},Application.prototype.replaceScene=function(a){this.currentScene&&(this.currentScene.app=null,this.currentScene.onexit()),this.sceneStack.pop(),this.sceneStack.push(a),this.currentScene=a,this.currentScene.app=this,this.currentScene.onenter()},Application.prototype.pushScene=function(a){this.sceneStack.length>0&&this.sceneStack[this.sceneStack.length-1].onexit(),this.sceneStack.push(a),a.app=this,this.currentScene=a,a.onenter()},Application.prototype.popScene=function(){var a=this.sceneStack.pop();a&&(a.onexit(),a.app=null,this.sceneStack.length>0?(this.currentScene=this.sceneStack[this.sceneStack.length-1],this.currentScene.onenter()):this.currentScene=null)},Application.INSTANCE=null;var Node=function(){this.parent=null,this.children=[],this.frame=0,this.visible=!0};Node.prototype.addChild=function(a){a.parent=this,this.children.push(a),a.onadded()},Node.prototype.addChildTo=function(a){return a.addChild(this),this},Node.prototype.removeChild=function(a){var b=this.children.indexOf(a);b>=0&&(a.parent=null,this.children.splice(b,1),a.onremoved())},Node.prototype.remove=function(){return null!==this.parent&&this.parent.removeChild(this),this},Node.prototype._update=function(a){this.update(a);for(var b=[].concat(this.children),c=0,d=b.length;d>c;c++)b[c]._update(a);this.frame+=1},Node.prototype._draw=function(a){if(a.save(),this.visible){this.predraw(a),this.draw(a);for(var b=0,c=this.children.length;c>b;b++)this.children[b]._draw(a)}a.restore()},Node.prototype.update=function(){},Node.prototype.predraw=function(){},Node.prototype.draw=function(){},Node.prototype.onadded=function(){},Node.prototype.onremoved=function(){};var Object2d=function(){Node.call(this),this.width=0,this.height=0,this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.originX=.5,this.originY=.5};Object2d.prototype=Object.create(Node.prototype),Object2d.prototype.predraw=function(a){a.translate(this.x,this.y),a.rotate(this.rotation),a.scale(this.scaleX,this.scaleY)},Object2d.prototype.setPosition=function(a,b){return this.x=a,this.y=b,this},Object2d.prototype.setScale=function(a,b){return 1===arguments.length&&(b=a),this.scaleX=a,this.scaleY=b,this},Object2d.prototype.setRotation=function(a){return this.rotation=a,this};var Menu=function(){Node.call(this),this.selected=null,this.enabled=!0};Menu.prototype=Object.create(Node.prototype),Menu.prototype.update=function(a){if(this.enabled)for(var b=a.pointing,c=0,d=this.children.length;d>c;c++){var e=this.children[c];if(e.scaleX=e.scaleY=this.selected===e?1+.1*Math.sin(.3*a.frame):1,b.isEnd&&e.isHitPoint(b)){this.selected===e?this.onSelectItem(e):(this.selected=e,this.onPreSelectItem(e));break}}},Menu.prototype.enable=function(){this.enabled=!0},Menu.prototype.disable=function(){this.enabled=!1;for(var a=0,b=this.children.length;b>a;a++){var c=this.children[a];c.scaleX=c.scaleY=1}},Menu.prototype.onPreSelectItem=function(){},Menu.prototype.onSelectItem=function(){};var Layer=function(a,b){Node.call(this),this.canvas=a,a.width=SC_W,a.height=SC_H,this.context=a.getContext2d(),this.drawRate=b};Layer.prototype=Object.create(Node.prototype),Layer.prototype._draw=function(){if(this.frame%this.drawRate===0){this.context.clearRect(0,0,SC_W,SC_H),this.context.save(),this.draw(this.context);for(var a=0,b=this.children.length;b>a;a++)this.children[a]._draw(this.context);this.context.restore()}};var Scene=function(){Node.call(this),this.app=null};Scene.prototype=Object.create(Node.prototype),Scene.prototype.onenter=function(){},Scene.prototype.onexit=function(){};var Assets={},AssetLoadScene=function(a,b){Scene.call(this),this.nextScene=b,this.allCount=0;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c].match(/\.\w+/);if(d)switch(d[0]){case".mp3":this._loadAudio(c,a[c])}this.allCount+=1}this.loadedCount=0;var e=this.label=new Label("ロード中...",20,240);e.x=.5*SC_W,e.y=.5*SC_H,e.addChildTo(this)};AssetLoadScene.prototype=Object.create(Scene.prototype),AssetLoadScene.prototype._loadAudio=function(a,b){var c=new Xhr({url:b,responseType:"arraybuffer"});c.onsuccess=function(b){var c=new Sound(b),d=this;c.onload=function(){Assets[a]=this,d.loadedCount+=1}}.bind(this),c.send()},AssetLoadScene.prototype.update=function(a){this.label.scaleX=this.label.scaleY=1+.2*Math.sin(.1*a.frame),this.loadedCount===this.allCount&&a.replaceScene(this.nextScene)};var Xhr=function(a){this.param=a;var b=this,c=this.xhr=new XMLHttpRequest;c.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),c.onreadystatechange=function(){4===this.readyState&&(200===this.status?b.onsuccess(this.response):b.onerror(this),b.oncomplete(this))},c.open(a.type||"GET",a.url),a.responseType&&(c.responseType=a.responseType)};Xhr.prototype.send=function(){this.param.data?this.xhr.send(this.param.data):this.xhr.send()},Xhr.prototype.onsuccess=function(){},Xhr.prototype.onerror=function(){},Xhr.prototype.oncomplete=function(){};var Jsonp=function(a){this.param=a,this.callbackName="_jsonpcallback_"+(new Date).getTime()+parseInt(1e3*Math.random());var b=this;window[this.callbackName]=function(a){delete window[b.callbackName],window.document.body.removeChild(b.script),b.onsuccess(a)}};Jsonp.prototype.send=function(){this.script=window.document.createElement("script"),this.script.src=this.param.data?this.param.url+"?"+this.param.data+"&callback="+this.callbackName:this.param.url+"?callback="+this.callbackName;try{window.document.body.appendChild(this.script)}catch(a){this.onerror(a)}},Jsonp.prototype.onsuccess=function(){},Jsonp.prototype.onerror=function(){},Jsonp.prototype.oncomplete=function(){};var Sound=function(a){if(this.buffer=null,this.source=null,this.gainNode=null,null===Sound.CONTEXT)throw new Error("webkitAudioContext is not defined.");a instanceof ArrayBuffer?Sound.CONTEXT.decodeAudioData(a,function(a){this.buffer=a,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload()}.bind(this)):a instanceof AudioBuffer&&(this.buffer=a,this.source=Sound.CONTEXT.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=Sound.CONTEXT.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(Sound.CONTEXT.destination),this.onload())};Sound.prototype=Object.create(Object.prototype,{volume:{get:function(){return this.gainNode.gain.value},set:function(a){this.gainNode.gain.value=a}},loop:{get:function(){return this.source.loop},set:function(a){this.source.loop=a}},loopStart:{get:function(){return this.source.loopStart},set:function(a){this.source.loopStart=a}},loopEnd:{get:function(){return this.source.loopEnd},set:function(a){this.source.loopEnd=a}}}),Sound.prototype.onload=function(){},Sound.prototype.start=function(){this.source.start(0)},Sound.prototype.play=Sound.prototype.start,Sound.prototype.stop=function(){this.source.stop(0),this.source.disconnect();var a=this.gainNode.gain.value;this.source=Sound.CONTEXT.createBufferSource(),this.gainNode.gain.value=a,this.source.buffer=this.buffer,this.source.connect(Sound.CONTEXT.destination)},Sound.prototype.clone=function(){var a=new Sound(this.buffer);return a.volume=this.volume,a.loop=this.loop,a.loopStart=this.loopStart,a.loopEnd=this.loopEnd,a},Sound.CONTEXT=null,window.webkitAudioContext?Sound.CONTEXT=new webkitAudioContext:window.mozAudioContext?Sound.CONTEXT=new mozAudioContext:window.AudioContext&&(Sound.CONTEXT=new AudioContext);var SoundEngine={};SoundEngine.bgm=null,SoundEngine.bgmName=null,SoundEngine.playing={},SoundEngine.playSE=function(a){if(Assets[a]){if(SoundEngine.playing[a]===Application.INSTANCE.frame)return;SoundEngine.playing[a]=Application.INSTANCE.frame;var b=Assets[a].clone();b.volume=OptionSettings.seVolume,b.start()}},SoundEngine.startBgm=function(a){SoundEngine.bgmName!==a&&(SoundEngine.stopBgm(),Assets[a]&&(SoundEngine.bgmName=a,SoundEngine.bgm=Assets[a].clone(),SoundEngine.bgm.loop=!0,SoundEngine.bgm.volume=OptionSettings.bgmVolume,SoundEngine.bgm.start()))},SoundEngine.stopBgm=function(){SoundEngine.bgm&&(SoundEngine.bgm.stop(),SoundEngine.bgm=null,SoundEngine.bgmName=null)};var Sprite=function(a){Object2d.call(this),this.texture=a,this.width=a.width,this.height=a.height,this.alpha=1,this.blendMode="lighter"};Sprite.prototype=Object.create(Object2d.prototype),Sprite.prototype.draw=function(a){a.globalAlpha=this.alpha,a.globalCompositeOperation=this.blendMode,a.drawImage(this.texture,-this.width*this.originX,-this.height*this.originY)},Sprite.prototype.isHitPoint=function(a){var b=this.width*this.scaleX*.5,c=this.height*this.scaleY*.5;return this.x-b<=a.x&&a.x<this.x+b&&this.y-c<=a.y&&a.y<this.y+c};var Rect=function(a,b,c){var d=new Canvas(b,c).set({color:a}).drawRect(2,2,b-4,c-4).toTexture();Sprite.call(this,d)};Rect.prototype=Object.create(Sprite.prototype);var RoundRect=function(a,b,c){var d=new Canvas(b,c).set({color:a}).drawRoundRect(2,2,b-4,c-4).toTexture();Sprite.call(this,d)};RoundRect.prototype=Object.create(Sprite.prototype);var Circle=function(a,b){this.radius=b;var c=new Canvas(2*b,2*b).set({color:a}).drawCircle(b,b,b-2).toTexture();Sprite.call(this,c)};Circle.prototype=Object.create(Sprite.prototype);var Polygon=function(a,b,c){var d=window.document.createElement("canvas");d.width=2*b,d.height=2*b;var e=d.getContext2d();Util.setStyle(e,a),e.beginPath(),e.moveTo(b+Math.cos(0)*(b-2),b+Math.sin(0)*(b-2));for(var f=1;c>f;f++){var g=2*Math.PI*f/c;e.lineTo(b+Math.cos(g)*(b-2),b+Math.sin(g)*(b-2))}e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d)};Polygon.prototype=Object.create(Sprite.prototype);var RandomPolygon=function(a,b,c){var d=window.document.createElement("canvas");d.width=2*b,d.height=2*b;var e=d.getContext2d();Util.setStyle(e,a);var f=(b-2)*(.5+.5*Math.random());e.beginPath(),e.moveTo(b+Math.cos(0)*f,b+Math.sin(0)*f);for(var g=1;c>g;g++){var h=2*Math.PI*g/c;f=(b-2)*(.5+.5*Math.random()),e.lineTo(b+Math.cos(h)*f,b+Math.sin(h)*f)}e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d)};RandomPolygon.prototype=Object.create(Sprite.prototype);var Fighter=function(a,b,c){var d=new Canvas(b,c),e=d.context;Util.setStyle(e,220),e.beginPath(),e.moveTo(.35*b,.4*c),e.lineTo(.4*b,.8*c),e.lineTo(.2*b,.9*c),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(.65*b,.4*c),e.lineTo(.8*b,.9*c),e.lineTo(.6*b,.8*c),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(.5*b,.1*c),e.lineTo(.65*b,.7*c),e.lineTo(.35*b,.7*c),e.closePath(),e.fill(),e.stroke(),Sprite.call(this,d.toTexture())};Fighter.prototype=Object.create(Sprite.prototype);var Label=function(a,b,c){this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this._text=a,this._fontSize=b||24,this.setColor(c||0);var d=this.updateText();Sprite.call(this,d)};Label.prototype=Object.create(Sprite.prototype,{text:{get:function(){return this._text},set:function(a){this.setText(a)}},fontSize:{get:function(){return this._fontSize},set:function(a){this.setFontSize(a)}}}),Label.prototype.setColor=function(a){this.fillStyle="hsla("+a+", 50%, 80%, 1.0)"},Label.prototype.setText=function(a){this._text=a,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.setFontSize=function(a){this._fontSize=a,this.texture=this.updateText(),this.width=this.texture.width,this.height=this.texture.height},Label.prototype.updateText=function(){var a=window.document.createElement("canvas"),b=a.getContext2d(!0);b.font=""+this._fontSize+"px 'uni'";var c=b.measureText(this._text);return a.width=c.width+5,a.height=this._fontSize,b.font=""+this._fontSize+"px 'uni'",b.textAlign="center",b.textBaseline="middle",b.fillStyle=this.fillStyle,b.lineWidth=2,b.fillText(this._text,.5*a.width,.5*a.height),a};var Util={style:function(a){return{fillStyle:"hsla("+a+", 80%, 20%, 0.5)",strokeStyle:"hsla("+a+", 50%, 80%, 1.0)",lineWidth:2}},setStyle:function(a,b){var c=this.style(b);a.fillStyle=c.fillStyle,a.strokeStyle=c.strokeStyle,a.lineWidth=c.lineWidth},linearGradient:function(a,b,c,d,e){for(var f=window.document.createElement("canvas").getContext2d(),g=f.createLinearGradient(a,b,c,d),h=0;h<e.length;h++)g.addColorStop(e[h].offset,e[h].color);return g},radialGradient:function(a,b,c,d,e,f,g){for(var h=window.document.createElement("canvas").getContext2d(),i=h.createRadialGradient(a,b,c,d,e,f),j=0;j<g.length;j++)i.addColorStop(g[j].offset,g[j].color);return i},range:function(a,b){for(var c=[],d=a;b>d;d++)c.push(d);return c},curry:function(a){return function b(c){return c.length<a.length?function(a){return b(c.concat([a]))}:a.apply(void 0,c)}([])},rand:function(a,b){return a+Math.random()*(b-a)},randi:function(a,b){return parseInt(a+Math.random()*(b-a))},clamp:function(a,b,c){return Math.max(b,Math.min(a,c))}},Http={queryParameter:function(a){var b="",c=!0;for(var d in a)a.hasOwnProperty(d)&&(c||(b+="&"),b+=encodeURI(d)+"="+encodeURI(a[d]),c=!1);return b}},Tweener=function(a){Node.call(this),this.target=a,this.actions=[],this.actionPointer=0,this.loop=!1,this.addChildTo(a)};Tweener.prototype=Object.create(Node.prototype),Tweener.prototype.update=function(){var a=this.actions[this.actionPointer];void 0!==a&&(a.currentPos<0&&a.initialize(this.target),a.update(this.target)&&(this.actionPointer+=1,this.actions.length===this.actionPointer&&(this.loop?this.actionPointer=0:this.remove())))},Tweener.prototype.add=function(a){return this.actions.push(a),this},Tweener.prototype.to=function(a,b,c){return this.add(new TweenAction(a,b,c))},Tweener.prototype.moveTo=function(a,b,c,d){return this.to({x:a,y:b},c,d)},Tweener.prototype.wait=function(a){return this.add(new Action(a))},Tweener.prototype.then=function(a){return this.add(new CallAction(a))},Tweener.prototype.setLoop=function(a){return this.loop=a,this};var Action=function(a){this.time=a,this.currentPos=-1};Action.prototype.initialize=function(){this.currentPos=0},Action.prototype.update=function(a){return this.currentPos+=1,this.currentPos===this.time&&this.finalize(a),this.currentPos>=this.time},Action.prototype.finalize=function(){};var CallAction=function(a){Action.call(this,0),this.func=a};CallAction.prototype=Object.create(Action.prototype),CallAction.prototype.update=function(a){return this.func&&this.func.call(a),Action.prototype.update.call(this,a)};var TweenAction=function(a,b,c){Action.call(this,b),this.param=a,this.ease=c||function(a){return a},this.initials={},this.deltas={}};TweenAction.prototype=Object.create(Action.prototype),TweenAction.prototype.initialize=function(a){Action.prototype.initialize.call(this,a);for(var b in this.param)this.initials[b]=a[b],this.deltas[b]=this.param[b]-a[b]},TweenAction.prototype.update=function(a){var b=this.ease(this.currentPos/this.time);for(var c in this.param)a[c]=this.initials[c]+this.deltas[c]*b;return Action.prototype.update.call(this,a)},TweenAction.prototype.finalize=function(a){for(var b in this.param)a[b]=this.param[b]};var Canvas=function(a,b){this.canvas=window.document.createElement("canvas"),this.width=this.canvas.width=a,this.height=this.canvas.height=b,this.context=this.canvas.getContext2d()};Canvas.prototype.set=function(a){var b=this.context;return void 0!==a.color?Util.setStyle(b,a.color):(b.fillStyle=a.fillStyle||"red",b.strokeStyle=a.strokeStyle||"white",b.lineWidth=a.lineWidth||2),this},Canvas.prototype.toTexture=function(){return this.canvas},Canvas.prototype.fillRect=function(a,b,c,d){return this.context.fillRect(a,b,c,d),this},Canvas.prototype.drawRect=function(a,b,c,d){return this.context.fillRect(a,b,c,d),this.context.strokeRect(a,b,c,d),this},Canvas.prototype.drawRoundRect=function(a,b,c,d,e){e=e||10;var f=this.context;return f.beginPath(),f.moveTo(a+e,b),f.lineTo(a+c-e,b),f.arcTo(a+c,b,a+c,b+e,e),f.lineTo(a+c,b+d-e),f.arcTo(a+c,b+d,a+c-e,b+d,e),f.lineTo(a+e,b+d),f.arcTo(a,b+d,a,b+d-e,e),f.lineTo(a,b+e),f.arcTo(a,b,a+e,b,e),f.closePath(),f.fill(),f.stroke(),this},Canvas.prototype.drawCircle=function(a,b,c){return this.context.arc(a,b,c,0,2*Math.PI,!1),this.context.fill(),this.context.stroke(),this},Canvas.prototype.drawPolygon=function(a,b,c,d,e){e=e||0,this.context.beginPath(),this.context.moveTo(a+Math.cos(e)*c,b+Math.sin(e)*c);for(var f=1;d>f;f++){var g=e+2*Math.PI*f/d;this.context.lineTo(a+Math.cos(g)*c,b+Math.sin(g)*c)}this.context.closePath(),this.context.fill(),this.context.stroke()},Canvas.prototype.drawLines=function(){this.context.beginPath(),this.context.moveTo(arguments[0][0],arguments[0][1]);for(var a=1;a<arguments.length;a++)this.context.lineTo(arguments[a][0],arguments[a][1]);this.context.closePath(),this.context.fill(),this.context.stroke()};var NineleapUtil={gotoLogin:function(){window.location.replace("http://9leap.net/api/login")},isOn9leap:function(){return"r.jsgames.jp"===window.location.hostname},scoreEntry:function(a,b){if(NineleapUtil.isOn9leap()){var c=window.location.pathname.match(/^\/games\/(\d+)/)[1];window.location.replace(["http://9leap.net/games/",c,"/result","?score=",window.encodeURIComponent(a),"&result=",window.encodeURIComponent(b)].join(""))}else window.location.replace(window.location.href)},getGameId:function(){return NineleapUtil.isOn9leap()?window.location.pathname.match(/^\/games\/(\d+)/)[1]:NineleapUtil.DEBUG_GAME_ID},getMyData:function(a){var b=new Jsonp({url:NineleapUtil.createMyDataURL()});b.onsuccess=function(b){a(null,b)},b.onerror=function(b){a(b)},b.send()},postMyData:function(a,b){if(!NineleapUtil.isOn9leap())return void b("not on 9leap.net");var c=new Xhr({type:"POST",url:NineleapUtil.createURL("user_memory.json"),data:"json="+JSON.stringify(a)});c.onsuccess=function(){b(null)},c.onerror=function(a){b(new Error(a))},c.send()},createURL:function(){for(var a=["http://9leap.net/api/memory/",NineleapUtil.getGameId()+"/"],b=0,c=arguments.length;c>b;b++)a.push(arguments[b]);return a.join("")},createMyDataURL:function(){return NineleapUtil.createURL("user_memory.json")},createUserDataURL:function(a){return NineleapUtil.createURL("u/",a+".json")},createRecentDataURL:function(a){return a=a||30,NineleapUtil.createURL("recent_memories.json","?max="+a)},createFriendDataURL:function(a){return a=a||30,NineleapUtil.createURL("friends_memories.json","?max="+a)},createRankingDataURL:function(a){return a=a||30,NineleapUtil.createURL("ranking_memories.json","?max="+a)}};NineleapUtil.DEBUG_GAME_ID="1888";